---
title: å¹¶å‘æ¨¡å‹ä¸äº‹ä»¶å¾ªç¯
date: 2019-08-31 05:21:26
tags: javascript
---
## è¿è¡Œæ—¶æ¦‚å¿µ

javascriptæ˜¯**å•çº¿ç¨‹**è¯­è¨€ï¼Œè¿™å°±æ„å‘³ç€æµè§ˆå™¨çš„**ä¸»çº¿ç¨‹**ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚

### å¯è§†åŒ–æè¿°

![ç¤ºæ„å›¾](https://developer.mozilla.org/files/4617/default.svg "ç¤ºæ„å›¾")

### æ ˆ

å‡½æ•°è°ƒç”¨æ—¶å½¢æˆäº†ä¸€ä¸ªå¸§æ ˆã€‚

``` javascript
function foo(b) {
  var a = 10;
  return a + b + 11;
}

function bar(x) {
  var y = 3;
  return foo(x * y);
}

console.log(bar(7)); // è¿”å› 42
```

å½“è°ƒç”¨ bar æ—¶ï¼Œåˆ›å»ºäº†ç¬¬ä¸€ä¸ªå¸§ ï¼Œå¸§ä¸­åŒ…å«äº† bar çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚å½“ bar è°ƒç”¨ foo æ—¶ï¼Œç¬¬äºŒä¸ªå¸§å°±è¢«åˆ›å»ºï¼Œå¹¶è¢«å‹åˆ°ç¬¬ä¸€ä¸ªå¸§ä¹‹ä¸Šï¼Œå¸§ä¸­åŒ…å«äº† foo çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚å½“ foo è¿”å›æ—¶ï¼Œæœ€ä¸Šå±‚çš„å¸§å°±è¢«å¼¹å‡ºæ ˆï¼ˆå‰©ä¸‹ bar å‡½æ•°çš„è°ƒç”¨å¸§ ï¼‰ã€‚å½“ bar è¿”å›çš„æ—¶å€™ï¼Œæ ˆå°±ç©ºäº†ã€‚

### å †

å¯¹è±¡è¢«åˆ†é…åœ¨ä¸€ä¸ªå †ä¸­ï¼Œå³ç”¨ä»¥è¡¨ç¤ºä¸€å¤§å—éç»“æ„åŒ–çš„å†…å­˜åŒºåŸŸã€‚

### é˜Ÿåˆ—

ä¸€ä¸ª JavaScript è¿è¡Œæ—¶åŒ…å«äº†ä¸€ä¸ªå¾…å¤„ç†çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½å…³è”ç€ä¸€ä¸ªç”¨ä»¥å¤„ç†è¿™ä¸ªæ¶ˆæ¯çš„å‡½æ•°ã€‚

åœ¨äº‹ä»¶å¾ªç¯æœŸé—´çš„æŸä¸ªæ—¶åˆ»ï¼Œè¿è¡Œæ—¶ä»æœ€å…ˆè¿›å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯å¼€å§‹å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚ä¸ºæ­¤ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¼šè¢«ç§»å‡ºé˜Ÿåˆ—ï¼Œå¹¶ä½œä¸ºè¾“å…¥å‚æ•°è°ƒç”¨ä¸ä¹‹å…³è”çš„å‡½æ•°ã€‚æ­£å¦‚å‰é¢æ‰€æåˆ°çš„ï¼Œè°ƒç”¨ä¸€ä¸ªå‡½æ•°æ€»æ˜¯ä¼šä¸ºå…¶åˆ›é€ ä¸€ä¸ªæ–°çš„æ ˆå¸§ã€‚

å‡½æ•°çš„å¤„ç†ä¼šä¸€ç›´è¿›è¡Œåˆ°æ‰§è¡Œæ ˆå†æ¬¡ä¸ºç©ºä¸ºæ­¢ï¼›ç„¶åäº‹ä»¶å¾ªç¯å°†ä¼šå¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼ˆå¦‚æœè¿˜æœ‰çš„è¯ï¼‰ã€‚

## äº‹ä»¶å¾ªç¯

ä¹‹æ‰€ä»¥ç§°ä¹‹ä¸ºäº‹ä»¶å¾ªç¯ï¼Œæ˜¯å› ä¸ºå®ƒç»å¸¸æŒ‰ç…§ç±»ä¼¼å¦‚ä¸‹çš„æ–¹å¼æ¥è¢«å®ç°ï¼š

``` javascript
while (queue.waitForMessage()) {
  queue.processNextMessage();
}
```

å¦‚æœå½“å‰æ²¡æœ‰ä»»ä½•æ¶ˆæ¯ï¼Œqueue.waitForMessage() ä¼šåŒæ­¥åœ°ç­‰å¾…æ¶ˆæ¯åˆ°è¾¾ã€‚

### æ‰§è¡Œè‡³å®Œæˆ

æ¯ä¸€ä¸ªæ¶ˆæ¯å®Œæ•´åœ°æ‰§è¡Œåï¼Œå…¶å®ƒæ¶ˆæ¯æ‰ä¼šè¢«æ‰§è¡Œã€‚è¿™ä¸ºç¨‹åºçš„åˆ†ææä¾›äº†ä¸€äº›ä¼˜ç§€çš„ç‰¹æ€§ï¼ŒåŒ…æ‹¬ï¼šä¸€ä¸ªå‡½æ•°æ‰§è¡Œæ—¶ï¼Œå®ƒæ°¸è¿œä¸ä¼šè¢«æŠ¢å ï¼Œå¹¶ä¸”åœ¨å…¶ä»–ä»£ç è¿è¡Œä¹‹å‰å®Œå…¨è¿è¡Œï¼ˆä¸”å¯ä»¥ä¿®æ”¹æ­¤å‡½æ•°æ“ä½œçš„æ•°æ®ï¼‰ã€‚è¿™ä¸Cè¯­è¨€ä¸åŒï¼Œä¾‹å¦‚ï¼Œå¦‚æœå‡½æ•°åœ¨çº¿ç¨‹ä¸­è¿è¡Œï¼Œå®ƒå¯èƒ½åœ¨ä»»ä½•ä½ç½®è¢«ç»ˆæ­¢ï¼Œç„¶ååœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå…¶ä»–ä»£ç ã€‚

è¿™ä¸ªæ¨¡å‹çš„ä¸€ä¸ªç¼ºç‚¹åœ¨äºå½“ä¸€ä¸ªæ¶ˆæ¯éœ€è¦å¤ªé•¿æ—¶é—´æ‰èƒ½å¤„ç†å®Œæ¯•æ—¶ï¼ŒWebåº”ç”¨å°±æ— æ³•å¤„ç†ç”¨æˆ·çš„äº¤äº’ï¼Œä¾‹å¦‚ç‚¹å‡»æˆ–æ»šåŠ¨ã€‚æµè§ˆå™¨ç”¨â€œç¨‹åºéœ€è¦è¿‡é•¿æ—¶é—´è¿è¡Œâ€çš„å¯¹è¯æ¡†æ¥ç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚ä¸€ä¸ªå¾ˆå¥½çš„åšæ³•æ˜¯ç¼©çŸ­æ¶ˆæ¯å¤„ç†ï¼Œå¹¶åœ¨å¯èƒ½çš„æƒ…å†µä¸‹å°†ä¸€ä¸ªæ¶ˆæ¯è£å‰ªæˆå¤šä¸ªæ¶ˆæ¯ã€‚

### æ·»åŠ æ¶ˆæ¯

åœ¨æµè§ˆå™¨é‡Œï¼Œå½“ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿä¸”æœ‰ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ç»‘å®šåœ¨è¯¥äº‹ä»¶ä¸Šæ—¶ï¼Œæ¶ˆæ¯ä¼šè¢«éšæ—¶æ·»åŠ è¿›é˜Ÿåˆ—ã€‚å¦‚æœæ²¡æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œäº‹ä»¶ä¼šä¸¢å¤±ã€‚æ‰€ä»¥ç‚¹å‡»ä¸€ä¸ªé™„å¸¦ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°çš„å…ƒç´ ä¼šæ·»åŠ ä¸€ä¸ªæ¶ˆæ¯ï¼Œå…¶å®ƒäº‹ä»¶ç±»ä¼¼ã€‚

å‡½æ•° setTimeout æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šå¾…åŠ å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯å’Œä¸€ä¸ªå»¶è¿Ÿï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º 0ï¼‰ã€‚è¿™ä¸ªå»¶è¿Ÿä»£è¡¨äº†æ¶ˆæ¯è¢«å®é™…åŠ å…¥åˆ°é˜Ÿåˆ—çš„æœ€å°å»¶è¿Ÿæ—¶é—´ã€‚å¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰å…¶å®ƒæ¶ˆæ¯ï¼Œåœ¨è¿™æ®µå»¶è¿Ÿæ—¶é—´è¿‡å»ä¹‹åï¼Œæ¶ˆæ¯ä¼šè¢«é©¬ä¸Šå¤„ç†ã€‚ä½†æ˜¯ï¼Œå¦‚æœæœ‰å…¶å®ƒæ¶ˆæ¯ï¼ŒsetTimeout æ¶ˆæ¯å¿…é¡»ç­‰å¾…å…¶å®ƒæ¶ˆæ¯å¤„ç†å®Œã€‚å› æ­¤ç¬¬äºŒä¸ªå‚æ•°ä»…ä»…è¡¨ç¤ºæœ€å°‘å»¶è¿Ÿæ—¶é—´ï¼Œè€Œéç¡®åˆ‡çš„ç­‰å¾…æ—¶é—´ã€‚

ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†è¿™ä¸ªæ¦‚å¿µï¼ˆsetTimeout å¹¶ä¸ä¼šåœ¨è®¡æ—¶å™¨åˆ°æœŸä¹‹åç›´æ¥æ‰§è¡Œï¼‰ï¼š

``` javascript
const s = new Date().getSeconds();

setTimeout(function() {
  // è¾“å‡º "2"ï¼Œè¡¨ç¤ºå›è°ƒå‡½æ•°å¹¶æ²¡æœ‰åœ¨ 500 æ¯«ç§’ä¹‹åç«‹å³æ‰§è¡Œ
  console.log("Ran after " + (new Date().getSeconds() - s) + " seconds");
}, 500);

while(true) {
  if(new Date().getSeconds() - s >= 2) {
    console.log("Good, looped for 2 seconds");
    break;
  }
}
```

### é›¶å»¶è¿Ÿ

é›¶å»¶è¿Ÿå¹¶ä¸æ„å‘³ç€å›è°ƒä¼šç«‹å³æ‰§è¡Œã€‚ä»¥ 0 ä¸ºç¬¬äºŒå‚æ•°è°ƒç”¨ setTimeout å¹¶ä¸è¡¨ç¤ºåœ¨ 0 æ¯«ç§’åå°±ç«‹å³è°ƒç”¨å›è°ƒå‡½æ•°ã€‚

å…¶ç­‰å¾…çš„æ—¶é—´å–å†³äºé˜Ÿåˆ—é‡Œå¾…å¤„ç†çš„æ¶ˆæ¯æ•°é‡ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œ"è¿™æ˜¯ä¸€æ¡æ¶ˆæ¯" å°†ä¼šåœ¨å›è°ƒè·å¾—å¤„ç†ä¹‹å‰è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¿™æ˜¯å› ä¸ºå»¶è¿Ÿå‚æ•°æ˜¯è¿è¡Œæ—¶å¤„ç†è¯·æ±‚æ‰€éœ€çš„æœ€å°ç­‰å¾…æ—¶é—´ï¼Œä½†å¹¶ä¸ä¿è¯æ˜¯å‡†ç¡®çš„ç­‰å¾…æ—¶é—´ã€‚

åŸºæœ¬ä¸Šï¼ŒsetTimeout éœ€è¦ç­‰å¾…å½“å‰é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„æ¶ˆæ¯éƒ½å¤„ç†å®Œæ¯•ä¹‹åæ‰èƒ½æ‰§è¡Œï¼Œå³ä½¿å·²ç»è¶…å‡ºäº†ç”±ç¬¬äºŒå‚æ•°æ‰€æŒ‡å®šçš„æ—¶é—´ã€‚

``` javascript
(function() {

  console.log('è¿™æ˜¯å¼€å§‹');

  setTimeout(function cb() {
    console.log('è¿™æ˜¯æ¥è‡ªç¬¬ä¸€ä¸ªå›è°ƒçš„æ¶ˆæ¯');
  });

  console.log('è¿™æ˜¯ä¸€æ¡æ¶ˆæ¯');

  setTimeout(function cb1() {
    console.log('è¿™æ˜¯æ¥è‡ªç¬¬äºŒä¸ªå›è°ƒçš„æ¶ˆæ¯');
  }, 0);

  console.log('è¿™æ˜¯ç»“æŸ');

})();

// "è¿™æ˜¯å¼€å§‹"
// "è¿™æ˜¯ä¸€æ¡æ¶ˆæ¯"
// "è¿™æ˜¯ç»“æŸ"
// æ­¤å¤„ï¼Œå‡½æ•°è¿”å›äº† undefined
// "è¿™æ˜¯æ¥è‡ªç¬¬ä¸€ä¸ªå›è°ƒçš„æ¶ˆæ¯"
// "è¿™æ˜¯æ¥è‡ªç¬¬äºŒä¸ªå›è°ƒçš„æ¶ˆæ¯"
```

### å¤šä¸ªè¿è¡Œæ—¶äº’ç›¸é€šä¿¡

ä¸€ä¸ª web worker æˆ–è€…ä¸€ä¸ªè·¨åŸŸçš„ iframe éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œå †å’Œæ¶ˆæ¯é˜Ÿåˆ—ã€‚ä¸¤ä¸ªä¸åŒçš„è¿è¡Œæ—¶åªèƒ½é€šè¿‡ postMessage æ–¹æ³•è¿›è¡Œé€šä¿¡ã€‚å¦‚æœå¦ä¸€ä¸ªè¿è¡Œæ—¶ä¾¦å¬ message äº‹ä»¶ï¼Œåˆ™æ­¤æ–¹æ³•ä¼šå‘è¯¥è¿è¡Œæ—¶æ·»åŠ æ¶ˆæ¯ã€‚

## æ°¸ä¸é˜»å¡

äº‹ä»¶å¾ªç¯æ¨¡å‹çš„ä¸€ä¸ªéå¸¸æœ‰è¶£çš„ç‰¹æ€§æ˜¯ï¼Œä¸è®¸å¤šå…¶ä»–è¯­è¨€ä¸åŒï¼ŒJavaScript æ°¸ä¸é˜»å¡ã€‚ å¤„ç† I/O é€šå¸¸é€šè¿‡äº‹ä»¶å’Œå›è°ƒæ¥æ‰§è¡Œï¼Œæ‰€ä»¥å½“ä¸€ä¸ªåº”ç”¨æ­£ç­‰å¾…ä¸€ä¸ª IndexedDB æŸ¥è¯¢è¿”å›æˆ–è€…ä¸€ä¸ª XHR è¯·æ±‚è¿”å›æ—¶ï¼Œå®ƒä»ç„¶å¯ä»¥å¤„ç†å…¶å®ƒäº‹æƒ…ï¼Œæ¯”å¦‚ç”¨æˆ·è¾“å…¥ã€‚

é—ç•™çš„ä¾‹å¤–æ˜¯å­˜åœ¨çš„ï¼Œå¦‚ alert æˆ–è€…åŒæ­¥ XHRï¼Œä½†åº”è¯¥å°½é‡é¿å…ä½¿ç”¨å®ƒä»¬ã€‚

## Microtaskå’ŒMacrotask

![jsäº‹ä»¶å¾ªç¯ç®€å›¾](https://user-gold-cdn.xitu.io/2017/5/26/fd34c53687584cd9b8d2a628d9178ba0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 "jsäº‹ä»¶å¾ªç¯ç®€å›¾")

ä¸€æ¬¡äº‹ä»¶å¾ªç¯ï¼šå…ˆè¿è¡ŒmacroTaské˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªï¼Œç„¶åè¿è¡ŒmicroTaské˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚æ¥ç€å¼€å§‹ä¸‹ä¸€æ¬¡å¾ªç¯ï¼ˆåªæ˜¯é’ˆå¯¹macroTaskå’ŒmicroTaskï¼Œä¸€æ¬¡å®Œæ•´çš„äº‹ä»¶å¾ªç¯ä¼šæ¯”è¿™ä¸ªå¤æ‚çš„å¤šï¼‰ã€‚

å…¶ä¸­macroTaskå’ŒmicroTaskæ˜¯ä¸¤ç§ä»»åŠ¡é˜Ÿåˆ—ï¼Œç›¸æ¯”è€Œè¨€ï¼Œå¤§å®¶æ›´ç†Ÿæ‚‰çš„ä¸€ä¸ªè¯æ˜¯ä»»åŠ¡é˜Ÿåˆ—ï¼ˆtask queue,å…¶å®å°±æ˜¯macroTaskï¼‰,å¤§å®¶æ›´ç†Ÿæ‚‰çš„å…³äºäº‹ä»¶å¾ªç¯çš„æœºåˆ¶è¯´æ³•å¤§æ¦‚æ˜¯ï¼šä¸»è¿›ç¨‹æ‰§è¡Œå®Œäº†ä¹‹åï¼Œæ¯æ¬¡ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œå–ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œã€‚ä½†æ˜¯promiseå‡ºç°ä¹‹åï¼Œè¿™ä¸ªè¯´æ³•å°±ä¸å¤ªå‡†ç¡®äº†ã€‚

JavaScriptå¼•æ“å¯¹è¿™ä¸¤ç§é˜Ÿåˆ—æœ‰ä¸åŒçš„å¤„ç†ï¼Œç®€å•çš„è¯´å°±æ˜¯å¼•æ“ä¼šæŠŠæˆ‘ä»¬çš„æ‰€æœ‰ä»»åŠ¡åˆ†é—¨åˆ«ç±»ï¼Œä¸€éƒ¨åˆ†å½’ä¸ºmacroTaskï¼Œå¦å¤–ä¸€éƒ¨åˆ†å½’ä¸ºmicroTaskï¼Œä¸‹é¢æ˜¯ç±»åˆ«åˆ’åˆ†ï¼š

- macroTask: setTimeout, setInterval, setImmediate, requestAnimationFrame, I/O, UI rendering
- microTask: process.nextTick, Promise, Object.observe(å·²åºŸå¼ƒ), MutationObserver

ç¤ºä¾‹ä»£ç ï¼š

``` javascript
console.log('main1');

process.nextTick(function() {
  console.log('process.nextTick1');
});

setTimeout(function() {
  console.log('setTimeout');
  process.nextTick(function() {
    console.log('process.nextTick2');
  });
}, 0);

new Promise(function(resolve, reject) {
  console.log('promise');
  resolve();
}).then(function() {
  console.log('promise then');
});

console.log('main2');
```

è¿è¡Œç»“æœï¼š

``` javascript
main1
promise
main2
process.nextTick1
promise then
setTimeout
process.nextTick2
```

process.nextTick å’Œ promise thenåœ¨ setTimeout å‰é¢è¾“å‡ºï¼Œå·²ç»è¯æ˜äº†macroTaskå’ŒmicroTaskçš„æ‰§è¡Œé¡ºåºã€‚ä½†æ˜¯æœ‰ä¸€ç‚¹å¿…é¡»è¦æŒ‡å‡ºçš„æ˜¯ã€‚ä¸Šé¢çš„å›¾å®¹æ˜“ç»™äººä¸€ä¸ªé”™è§‰ï¼Œå°±æ˜¯ä¸»è¿›ç¨‹çš„ä»£ç æ‰§è¡Œä¹‹åï¼Œä¼šå…ˆè°ƒç”¨macroTaskï¼Œå†è°ƒç”¨microTaskï¼Œè¿™æ ·åœ¨ç¬¬ä¸€ä¸ªå¾ªç¯é‡Œä¸€å®šæ˜¯macroTaskåœ¨å‰ï¼ŒmicroTaskåœ¨åã€‚

ä½†æ˜¯æœ€ç»ˆçš„å®è·µè¯æ˜ï¼šåœ¨ç¬¬ä¸€ä¸ªå¾ªç¯é‡Œï¼Œprocess.nextTick1å’Œpromise thenè¿™ä¸¤ä¸ªmicroTaskæ˜¯åœ¨setTimeoutè¿™ä¸ªmacroTaské‡Œä¹‹å‰è¾“å‡ºçš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºä¸»è¿›ç¨‹çš„ä»£ç ä¹Ÿå±äºmacroTaskï¼ˆè¿™ä¸€ç‚¹æˆ‘æ¯”è¾ƒç–‘æƒ‘çš„æ˜¯ä¸»è¿›ç¨‹éƒ½æ˜¯ä¸€äº›åŒæ­¥ä»£ç ï¼Œè€ŒmacroTaskå’ŒmicroTaskåŒ…å«çš„éƒ½æ˜¯ä¸€äº›å¼‚æ­¥ä»»åŠ¡ï¼Œä¸ºå•¥ä¸»è¿›ç¨‹çš„ä»£ç ä¼šè¢«åˆ’åˆ†ä¸ºmacroTaskï¼Œä¸è¿‡ä»å®è·µæ¥çœ‹ç¡®å®æ˜¯è¿™æ ·ï¼Œè€Œä¸”ä¹Ÿæœ‰ç†è®ºæ”¯æ’‘ï¼š[ã€ç¿»è¯‘ã€‘Promises/A+è§„èŒƒï¼‰](https://link.juejin.im/?target=http%3A%2F%2Fwww.ituring.com.cn%2Farticle%2F66566)ï¼‰ã€‚

ä¸»è¿›ç¨‹è¿™ä¸ªmacroTaskï¼ˆä¹Ÿå°±æ˜¯main1ã€promiseå’Œmain2ï¼‰æ‰§è¡Œå®Œäº†ï¼Œè‡ªç„¶ä¼šå»æ‰§è¡Œprocess.nextTick1å’Œpromise thenè¿™ä¸¤ä¸ªmicroTaskã€‚è¿™æ˜¯ç¬¬ä¸€ä¸ªå¾ªç¯ã€‚ä¹‹åçš„setTimeoutå’Œprocess.nextTick2å±äºç¬¬äºŒä¸ªå¾ªç¯ã€‚

requestAnimationFrameã€Object.observe(å·²åºŸå¼ƒ) å’Œ MutationObserverè¿™ä¸‰ä¸ªä»»åŠ¡çš„è¿è¡Œæœºåˆ¶å¤§å®¶å¯ä»¥ä»ä¸Šé¢çœ‹åˆ°ï¼Œä¸åŒçš„åªæ˜¯å…·ä½“ç”¨æ³•ä¸åŒã€‚é‡ç‚¹è¯´ä¸‹UI renderingã€‚åœ¨HTMLè§„èŒƒï¼ševent-loop-processing-modelé‡Œå™è¿°äº†ä¸€æ¬¡äº‹ä»¶å¾ªç¯çš„å¤„ç†è¿‡ç¨‹ï¼Œåœ¨å®Œæˆäº†ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¹‹å(å®Œæˆäº†macroTaskå’ŒmicroTask)ï¼Œå¯èƒ½ä¼šè¿›è¡Œä¸€æ¬¡Update the rendering(å–å†³äºä¸åŒæµè§ˆå™¨çš„æœºåˆ¶)ï¼Œå…¶ä¸­ç»†èŠ‚æ¯”è¾ƒå¤šï¼Œæ€»çš„æ¥è¯´ä¼šè¿›è¡Œä¸€æ¬¡UIçš„é‡æ–°æ¸²æŸ“ã€‚

## ä¸€ä¸ªğŸŒ°[ç‚¹å‡»è¿™é‡Œ](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)

``` javascript
// Let's get hold of those elements
var outer = document.querySelector('.outer');
var inner = document.querySelector('.inner');

// Let's listen for attribute changes on the
// outer element
new MutationObserver(function() {
  console.log('mutate');
}).observe(outer, {
  attributes: true
});

// Here's a click listenerâ€¦
function onClick() {
  console.log('click');

  setTimeout(function() {
    console.log('timeout');
  }, 0);

  Promise.resolve().then(function() {
    console.log('promise');
  });

  outer.setAttribute('data-random', Math.random());
}

// â€¦which we'll attach to both elements
inner.addEventListener('click', onClick);
outer.addEventListener('click', onClick);

// æ‰‹åŠ¨ç‚¹å‡»inner logå¦‚ä¸‹
`click
promise
mutate
click
promise
mutate
timeout
timeout`

// å¦‚æœåœ¨addEventListenerä¹‹åï¼Œç”¨è„šæœ¬è§¦å‘ç‚¹å‡»ï¼Œç»“æœåˆ™ä¸ä¸€æ ·
inner.click();
// logå¦‚ä¸‹ï¼ˆmutationåªè§¦å‘äº†ä¸€æ¬¡ï¼Œå› ä¸ºä¸¤ä¸ªç‚¹å‡»çš„å›è°ƒæ˜¯åŒæ­¥è°ƒç”¨çš„ï¼‰
`click
click
promise
mutate
promise
timeout
timeout`
```
